<!DOCTYPE html>
<!-- saved from url=(0065)https://saptak.in/writing/2025/05/10/google-adk-masterclass-part5 -->
<html class="no-js js" lang="en" data-theme="dark" style="display: block !important; white-space: normal !important;"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Google ADK Masterclass Part 5: Session and Memory Management</title>
<meta name="description" content="The home page of Saptak Sen, product manager, author, and software engineer at Hortonworks and Microsoft.">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">




<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@saptak">
<meta name="twitter:title" content="Google ADK Masterclass Part 5: Session and Memory Management">
<meta name="twitter:url" content="https://saptak.in/writing/2025/05/10/google-adk-masterclass-part5">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://saptak.in/assets/img/blog/thumbnails/2025-05-10-google-adk-masterclass-part5.jpg">

<meta property="og:title" content="Google ADK Masterclass Part 5: Session and Memory Management">
<meta property="og:url" content="https://saptak.in/writing/2025/05/10/google-adk-masterclass-part5">
<meta property="og:site_name" content="Saptak Sen">
<meta property="article:author" content="https://www.facebook.com/saptak">
<meta property="og:description" content="">
<meta property="og:image" content="https://saptak.in/assets/img/blog/thumbnails/2025-05-10-google-adk-masterclass-part5.jpg">



  
    <link rel="canonical" href="https://saptak.in/writing/2025/05/10/google-adk-masterclass-part5">
  


<link rel="apple-touch-icon" href="https://saptak.in/writing/2025/05/10/apple-touch-icon.png">
<link rel="alternate" type="application/rss+xml" title="Saptak Sen" href="https://saptak.in/feed.xml">


<link rel="apple-touch-icon" sizes="57x57" href="https://saptak.in/assets/img/icons/favicon/favicon.ico">
<link rel="apple-touch-icon" sizes="60x60" href="https://saptak.in/assets/img/icons/favicon/favicon.ico">
<link rel="apple-touch-icon" sizes="72x72" href="https://saptak.in/assets/img/icons/favicon/favicon.ico">
<link rel="apple-touch-icon" sizes="76x76" href="https://saptak.in/assets/img/icons/favicon/favicon.ico">
<link rel="apple-touch-icon" sizes="114x114" href="https://saptak.in/assets/img/icons/favicon/favicon.ico">
<link rel="apple-touch-icon" sizes="120x120" href="https://saptak.in/assets/img/icons/favicon/favicon.ico">
<link rel="apple-touch-icon" sizes="144x144" href="https://saptak.in/assets/img/icons/favicon/favicon.ico">
<link rel="apple-touch-icon" sizes="152x152" href="https://saptak.in/assets/img/icons/favicon/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="https://saptak.in/assets/img/icons/favicon/favicon.ico">
<link rel="icon" type="image/x-icon" sizes="192x192" href="https://saptak.in/assets/img/icons/favicon/favicon.ico">
<link rel="icon" type="image/x-icon" sizes="32x32" href="https://saptak.in/assets/img/icons/favicon/favicon.ico">
<link rel="icon" type="image/x-icon" sizes="96x96" href="https://saptak.in/assets/img/icons/favicon/favicon.ico">
<link rel="icon" type="image/x-icon" sizes="16x16" href="https://saptak.in/assets/img/icons/favicon/favicon.ico">
<link rel="manifest" href="https://saptak.in/assets/img/icons/favicon/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/assets/img/icons/favicon/favicon.ico">
<meta name="theme-color" content="#ffffff">

<link rel="stylesheet" type="text/css" href="./Google ADK Masterclass Part 5_ Session and Memory Management_files/css">
<link rel="stylesheet" type="text/css" href="./Google ADK Masterclass Part 5_ Session and Memory Management_files/main.css">

<!-- Blog layout override CSS -->
<link rel="stylesheet" type="text/css" href="./Google ADK Masterclass Part 5_ Session and Memory Management_files/blog-layout-override.css">

<!-- Dark mode initialization to prevent flash -->
<script async="" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/async-ads.js.download"></script><script type="text/javascript" async="" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/analytics.js.download"></script><script type="text/javascript" async="" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/js"></script><script type="text/javascript" async="" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/f.txt"></script><script>
  (function() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = savedTheme === 'dark' || (savedTheme === null && prefersDark) ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', theme);
  })();
</script>
<!-- Removed SumoMe script to reduce third-party dependencies -->
<!-- <script src="//load.sumome.com/" data-sumo-site-id="b49b2276c652916249c300f15e94a8f692f635a2e2fc22dcbfb5ea7de36c5923" async="async"></script> -->

<!-- Removed fundamine script that was causing connection timeout errors -->

  <!-- Direct tag fix style -->
<style>
/* Force tags to display on a single line that wraps naturally */
.tags-container {
  display: inline-block !important;
  white-space: normal !important;
}

.tag-link {
  display: inline !important;
  float: none !important;
}

.tag-separator {
  display: inline !important;
}

.mr1.nowrap, .tag-container-parent {
  white-space: normal !important;
  display: inline-block !important;
}
</style>

<script src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/cse_element__en.js.download" type="text/javascript"></script><link type="text/css" href="./Google ADK Masterclass Part 5_ Session and Memory Management_files/default+en.css" rel="stylesheet"><link type="text/css" href="./Google ADK Masterclass Part 5_ Session and Memory Management_files/default.css" rel="stylesheet"><style type="text/css">.gsc-control-cse{font-family:arial, sans-serif}.gsc-control-cse .gsc-table-result{font-family:arial, sans-serif}.gsc-refinementsGradient{background:linear-gradient(to left,rgba(255,255,255,1),rgba(255,255,255,0))}.gsc-control-cse{border-color:#FFFFFF;background-color:#FFFFFF}input.gsc-input,.gsc-input-box,.gsc-input-box-hover,.gsc-input-box-focus{border-color:#D9D9D9}.gsc-search-button-v2,.gsc-search-button-v2:hover,.gsc-search-button-v2:focus{border-color:#666666;background-color:#CECECE;background-image:none;filter:none}.gsc-search-button-v2 svg{fill:#FFFFFF}.gsc-tabHeader.gsc-tabhActive,.gsc-refinementHeader.gsc-refinementhActive{color:#CCCCCC;border-color:#CCCCCC;background-color:#FFFFFF}.gsc-tabHeader.gsc-tabhInactive,.gsc-refinementHeader.gsc-refinementhInactive{color:#CCCCCC;border-color:#CCCCCC;background-color:#FFFFFF}.gsc-webResult.gsc-result,.gsc-results .gsc-imageResult{border-color:#FFFFFF;background-color:#FFFFFF}.gsc-webResult.gsc-result:hover{border-color:#FFFFFF;background-color:#FFFFFF}.gs-webResult.gs-result a.gs-title:link,.gs-webResult.gs-result a.gs-title:link b,.gs-imageResult a.gs-title:link,.gs-imageResult a.gs-title:link b{color:#0000CC}.gs-webResult.gs-result a.gs-title:visited,.gs-webResult.gs-result a.gs-title:visited b,.gs-imageResult a.gs-title:visited,.gs-imageResult a.gs-title:visited b{color:#0000CC}.gs-webResult.gs-result a.gs-title:hover,.gs-webResult.gs-result a.gs-title:hover b,.gs-imageResult a.gs-title:hover,.gs-imageResult a.gs-title:hover b{color:#0000CC}.gs-webResult.gs-result a.gs-title:active,.gs-webResult.gs-result a.gs-title:active b,.gs-imageResult a.gs-title:active,.gs-imageResult a.gs-title:active b{color:#0000CC}.gsc-cursor-page{color:#0000CC}a.gsc-trailing-more-results:link{color:#0000CC}.gs-webResult:not(.gs-no-results-result):not(.gs-error-result) .gs-snippet,.gs-fileFormatType{color:#000000}.gs-webResult div.gs-visibleUrl{color:#008000}.gs-webResult div.gs-visibleUrl-short{color:#008000}.gsc-cursor-box{border-color:#FFFFFF}.gsc-results .gsc-cursor-box .gsc-cursor-page{border-color:#CCCCCC;background-color:#FFFFFF;color:#CCCCCC}.gsc-results .gsc-cursor-box .gsc-cursor-current-page{border-color:#CCCCCC;background-color:#FFFFFF;color:#CCCCCC}.gsc-webResult.gsc-result.gsc-promotion{border-color:#336699;background-color:#FFFFFF}.gsc-completion-title{color:#0000CC}.gsc-completion-snippet{color:#000000}.gs-promotion a.gs-title:link,.gs-promotion a.gs-title:link *,.gs-promotion .gs-snippet a:link{color:#0000CC}.gs-promotion a.gs-title:visited,.gs-promotion a.gs-title:visited *,.gs-promotion .gs-snippet a:visited{color:#0000CC}.gs-promotion a.gs-title:hover,.gs-promotion a.gs-title:hover *,.gs-promotion .gs-snippet a:hover{color:#0000CC}.gs-promotion a.gs-title:active,.gs-promotion a.gs-title:active *,.gs-promotion .gs-snippet a:active{color:#0000CC}.gs-promotion .gs-snippet,.gs-promotion .gs-title .gs-promotion-title-right,.gs-promotion .gs-title .gs-promotion-title-right *{color:#000000}.gs-promotion .gs-visibleUrl,.gs-promotion .gs-visibleUrl-short{color:#008000}.gcsc-find-more-on-google{color:#0000CC}.gcsc-find-more-on-google-magnifier{fill:#0000CC}</style><style type="text/css">.gscb_a{display:inline-block;font:27px/13px arial,sans-serif}.gsst_a .gscb_a{color:#a1b9ed;cursor:pointer}.gsst_a:hover .gscb_a,.gsst_a:focus .gscb_a{color:#36c}.gsst_a{display:inline-block}.gsst_a{cursor:pointer;padding:0 4px}.gsst_a:hover{text-decoration:none!important}.gsst_b{font-size:16px;padding:0 2px;position:relative;user-select:none;-webkit-user-select:none;white-space:nowrap}.gsst_e{vertical-align:middle;opacity:0.55;}.gsst_a:hover .gsst_e,.gsst_a:focus .gsst_e{opacity:0.72;}.gsst_a:active .gsst_e{opacity:1;}.gsst_f{background:white;text-align:left}.gsst_g{background-color:white;border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);margin:-1px -3px;padding:0 6px}.gsst_h{background-color:white;height:1px;margin-bottom:-1px;position:relative;top:-1px}.gsib_a{width:100%;padding:4px 6px 0}.gsib_a,.gsib_b{vertical-align:top}.gssb_c{border:0;position:absolute;z-index:989}.gssb_e{border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);cursor:default}.gssb_f{visibility:hidden;white-space:nowrap}.gssb_k{border:0;display:block;position:absolute;top:0;z-index:988}.gsdd_a{border:none!important}.gsq_a{padding:0}.gssb_a{padding:0 7px}.gssb_a,.gssb_a td{white-space:nowrap;overflow:hidden;line-height:22px}#gssb_b{font-size:11px;color:#36c;text-decoration:none}#gssb_b:hover{font-size:11px;color:#36c;text-decoration:underline}.gssb_g{text-align:center;padding:8px 0 7px;position:relative}.gssb_h{font-size:15px;height:28px;margin:0.2em;-webkit-appearance:button}.gssb_i{background:#eee}.gss_ifl{visibility:hidden;padding-left:5px}.gssb_i .gss_ifl{visibility:visible}a.gssb_j{font-size:13px;color:#36c;text-decoration:none;line-height:100%}a.gssb_j:hover{text-decoration:underline}.gssb_l{height:1px;background-color:#e5e5e5}.gssb_m{color:#000;background:#fff}.gssb_a{padding:0 9px}.gsib_a{padding:5px 9px 4px 9px}.gscb_a{line-height:27px}.gssb_e{border:0}.gssb_l{margin:5px 0}input.gsc-input::-webkit-input-placeholder{font-size:14px}input.gsc-input:-moz-placeholder{font-size:14px}input.gsc-input::-moz-placeholder{font-size:14px}input.gsc-input:-ms-input-placeholder{font-size:14px}input.gsc-input:focus::-webkit-input-placeholder{color:transparent}input.gsc-input:focus:-moz-placeholder{color:transparent}input.gsc-input:focus::-moz-placeholder{color:transparent}input.gsc-input:focus:-ms-input-placeholder{color:transparent}.gssb_c .gsc-completion-container{position:static}.gssb_c{z-index:5000}.gsc-completion-container table{background:transparent;font-size:inherit;font-family:inherit}.gssb_c > tbody > tr,.gssb_c > tbody > tr > td,.gssb_d,.gssb_d > tbody > tr,.gssb_d > tbody > tr > td,.gssb_e,.gssb_e > tbody > tr,.gssb_e > tbody > tr > td{padding:0;margin:0;border:0}.gssb_a table,.gssb_a table tr,.gssb_a table tr td{padding:0;margin:0;border:0}</style><style type="text/css">.js .nav-collapse-0.opened{max-height:0px !important} .js .nav-collapse-0.opened.dropdown-active {max-height:9999px !important}</style></head>
<body class="js-enabled" data-theme="dark" style="display: inline !important; white-space: normal !important;">
  <nav class="clearfix border-bottom border-light-gray" role="navigation">
  <div class="left">
    <a href="https://saptak.in/" class="button py2 button-transparent nav-button caps">
      <img src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/Saptak-Sen-b.lowres.png" alt="Saptak Sen" class="light-mode-logo" style="height: 32px; width: auto; vertical-align: middle; transform: translateY(-1px); object-fit: contain; display: none;">
      <img src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/Saptak-Sen-w.lowres.png" alt="Saptak Sen" class="dark-mode-logo" style="height: 32px; width: auto; vertical-align: middle; transform: translateY(-1px); display: inline-block; object-fit: contain;">
    </a>
  </div>
  <div class="right">
    <span style="display: inline-block; vertical-align: middle;">
      <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Toggle dark mode" style="vertical-align: middle;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="dark-mode-toggle-icon" width="20" height="20">
          <path class="sun-icon" d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0 2c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58l1.06 1.06c.39.39.39 1.03 0 1.41-.39.39-1.03.39-1.41 0L4.58 5.99c-.39-.39-.39-1.03 0-1.41s1.03-.39 1.41 0zm12.37 12.37l1.06 1.06c.39.39.39 1.03 0 1.41-.39.39-1.03.39-1.41 0l-1.06-1.06c-.39-.39-.39-1.03 0-1.41.39-.39 1.03-.39 1.41 0zM18.36 5.99l1.06-1.06c.39-.39 1.03-.39 1.41 0 .39.39.39 1.03 0 1.41l-1.06 1.06c-.39.39-1.03.39-1.41 0-.39-.39-.39-1.03 0-1.41zM7.05 18.36l-1.06 1.06c-.39.39-1.03.39-1.41 0-.39-.39-.39-1.03 0-1.41l1.06-1.06c.39-.39 1.03-.39 1.41 0 .39.39.39 1.03 0 1.41z" fill="currentColor" style="display: none;"></path>
          <path class="moon-icon" style="display: block;" d="M9.37 5.51c-.18.64-.27 1.31-.27 1.99 0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27C17.45 17.19 14.93 19 12 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49zM12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z" fill="currentColor"></path>
        </svg>
      </button>
    </span>
    
      <span style="display: inline-block; vertical-align: middle;">
        <a href="https://saptak.in/blog" class="button button-transparent py2 h6 nav-button caps" style="vertical-align: middle;">BLOG</a>
      </span>
    
      <span style="display: inline-block; vertical-align: middle;">
        <a href="https://gallery.saptak.in/" class="button button-transparent py2 h6 nav-button caps" style="vertical-align: middle;">GALLERY</a>
      </span>
    
  </div>
</nav>

<!-- Hidden nav-collapse element to prevent JavaScript errors -->
<div class="nav-collapse nav-collapse-0 opened" style="display: none; transition: max-height 284ms; position: relative; max-height: none; overflow: visible;">
  <!-- This element is only here to prevent JavaScript errors with responsive-nav.js -->
  <ul>
    
      <li><a href="https://saptak.in/blog">BLOG</a></li>
    
      <li><a href="https://gallery.saptak.in/">GALLERY</a></li>
    
  </ul>
</div>

  
  <main class="container block p3" role="main" id="main-content">
    
<div class="post-header-image-container">
  <img src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/2025-05-10-google-adk-masterclass-part5.jpg" alt="Google ADK Masterclass Part 5: Session and Memory Management" class="post-header-image">
</div>


<article class="post">
  <button id="tts-button" aria-label="Listen to this post" title="Listen to this post" style="margin-bottom: 1em; padding: 0; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; border: 2px solid #888; background: none; display: flex; align-items: center; justify-content: center; color: #888;">
    <!-- SVG Play Icon -->
    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
      <path d="M8 5v14l11-7z"></path>
    </svg>
  </button>
  <div id="post-content-for-tts">
    <h1 id="google-adk-masterclass-part-5-session-and-memory-management">Google ADK Masterclass Part 5: Session and Memory Management</h1>

<p><a href="https://saptak.in/writing/2025/05/10/google-adk-masterclass-overview">Overview</a></p>

<p>In our <a href="https://saptak.in/writing/2025/05/10/google-adk-masterclass-part4">previous tutorials</a>, we’ve been using ADK’s web interface to interact with our agents. Behind the scenes, ADK has been managing sessions, state, and the agent lifecycle for us. Now it’s time to pull back the curtain and understand these core components, which are essential for building more sophisticated agent applications.</p>

<p>In this tutorial, we’ll explore how session management and state work in ADK, and how to implement them in your own applications without relying on the web interface.</p>

<h2 id="understanding-the-core-components">Understanding the Core Components</h2>

<p>Let’s start by understanding the three key components of ADK’s memory management:</p>

<h3 id="1-sessions">1. Sessions</h3>

<p>A <strong>session</strong> is a stateful chat history between a user and one or more agents. It includes:</p>

<ul>
  <li><strong>ID</strong>: A unique identifier for the session</li>
  <li><strong>State</strong>: A dictionary of data persisted throughout the conversation</li>
  <li><strong>Events</strong>: A record of all interactions (messages, tool calls, agent responses)</li>
  <li><strong>Metadata</strong>: Information like app name, user ID, and last update time</li>
</ul>

<p>Sessions allow agents to maintain context over multiple interactions, which is essential for natural, coherent conversations.</p>

<h3 id="2-state">2. State</h3>

<p><strong>State</strong> is a key-value store within a session that persists information. State can include:</p>

<ul>
  <li>User preferences</li>
  <li>Conversation history</li>
  <li>Calculated values</li>
  <li>Structured outputs from agents</li>
  <li>Any other data you want to maintain across interactions</li>
</ul>

<p>State is one of the most powerful features of ADK, enabling agents to “remember” information without needing to pass it in each message.</p>

<h3 id="3-runners">3. Runners</h3>

<p>A <strong>runner</strong> connects agents with sessions, managing the flow of information between them. Runners handle:</p>

<ul>
  <li>Selecting which agent should respond to a request</li>
  <li>Passing context from the session to the agent</li>
  <li>Executing tool calls</li>
  <li>Updating the session with new events and state</li>
</ul>

<p>Think of runners as the “orchestrators” of your agent system.</p>

<h2 id="session-types-in-adk">Session Types in ADK</h2>

<p>ADK offers three types of session management:</p>

<ol>
  <li><strong>In-Memory Sessions</strong>: Data is stored in memory and lost when the application ends</li>
  <li><strong>Database Sessions</strong>: Data is persisted to a local database</li>
  <li><strong>Vertex AI Sessions</strong>: Data is stored in Google Cloud</li>
</ol>

<p>For this tutorial, we’ll focus on in-memory sessions, which are simplest for development and learning. In the next tutorial, we’ll explore database persistence.</p>

<h2 id="creating-a-basic-stateful-session">Creating a Basic Stateful Session</h2>

<p>Let’s build a simple question-answering agent that remembers user information:</p>

<h3 id="folder-structure">Folder Structure</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>session_management/
├── basic_stateful_session.py
├── .env
└── qa_agent/
    ├── __init__.py
    └── agent.py
</code></pre></div></div>

<h3 id="agent-implementation-qa_agentagentpy">Agent Implementation (qa_agent/agent.py)</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">google.adk</span> <span class="kn">import</span> <span class="n">Agent</span>

<span class="n">qa_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s">"qa_agent"</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s">"models/gemini-2.0-no-flash"</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s">"An agent that answers questions about user preferences"</span><span class="p">,</span>
    <span class="n">instructions</span><span class="o">=</span><span class="s">"""
    You are a helpful assistant that answers questions about the user's preferences.

    The user's name is {username}.

    The user has the following preferences:
    - Favorite color: {user_preferences.favorite_color}
    - Favorite food: {user_preferences.favorite_food}
    - Favorite movie: {user_preferences.favorite_movie}
    - Favorite TV show: {user_preferences.favorite_tv_show}

    Always answer questions about the user's preferences based on this information.
    """</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Notice the template variables in the instructions like <code class="language-plaintext highlighter-rouge">{username}</code> and <code class="language-plaintext highlighter-rouge">{user_preferences.favorite_color}</code>. These will be populated from state at runtime.</p>

<h3 id="session-management-script-basic_stateful_sessionpy">Session Management Script (basic_stateful_session.py)</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">google.generativeai.types</span> <span class="kn">import</span> <span class="n">content_types</span>
<span class="kn">from</span> <span class="nn">google.generativeai.types.content_types</span> <span class="kn">import</span> <span class="n">Part</span>

<span class="kn">from</span> <span class="nn">google.adk.orchestration</span> <span class="kn">import</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="nn">google.adk.orchestration.session</span> <span class="kn">import</span> <span class="n">InMemorySessionService</span>
<span class="kn">from</span> <span class="nn">google.adk.orchestration.session.session</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="c1"># Import the agent
</span><span class="kn">from</span> <span class="nn">qa_agent.agent</span> <span class="kn">import</span> <span class="n">qa_agent</span>

<span class="c1"># Load environment variables
</span><span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># Create an in-memory session service
</span><span class="n">session_service</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>

<span class="c1"># Define initial state with user information
</span><span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"username"</span><span class="p">:</span> <span class="s">"Brandon"</span><span class="p">,</span>
    <span class="s">"user_preferences"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"favorite_color"</span><span class="p">:</span> <span class="s">"Blue"</span><span class="p">,</span>
        <span class="s">"favorite_food"</span><span class="p">:</span> <span class="s">"Pizza"</span><span class="p">,</span>
        <span class="s">"favorite_movie"</span><span class="p">:</span> <span class="s">"The Matrix"</span><span class="p">,</span>
        <span class="s">"favorite_tv_show"</span><span class="p">:</span> <span class="s">"Game of Thrones"</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Create a new session
</span><span class="n">session_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="n">uuid4</span><span class="p">())</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">session_service</span><span class="p">.</span><span class="n">create_session</span><span class="p">(</span>
    <span class="n">app_name</span><span class="o">=</span><span class="s">"BrandonBot"</span><span class="p">,</span>
    <span class="n">user_id</span><span class="o">=</span><span class="s">"brandon_hancock"</span><span class="p">,</span>
    <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
    <span class="n">state</span><span class="o">=</span><span class="n">initial_state</span>
<span class="p">)</span>

<span class="c1"># Create a runner with our agent and session service
</span><span class="n">runner</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
    <span class="n">root_agent</span><span class="o">=</span><span class="n">qa_agent</span><span class="p">,</span>
    <span class="n">session_service</span><span class="o">=</span><span class="n">session_service</span>
<span class="p">)</span>

<span class="c1"># Create a message to send to the agent
</span><span class="n">message</span> <span class="o">=</span> <span class="n">content_types</span><span class="p">.</span><span class="n">Content</span><span class="p">(</span>
    <span class="n">role</span><span class="o">=</span><span class="s">"user"</span><span class="p">,</span>
    <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">Part</span><span class="p">.</span><span class="n">from_text</span><span class="p">(</span><span class="s">"What is Brandon's favorite TV show?"</span><span class="p">)]</span>
<span class="p">)</span>

<span class="c1"># Run the agent with our message
</span><span class="n">response</span> <span class="o">=</span> <span class="n">runner</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">user_id</span><span class="o">=</span><span class="s">"brandon_hancock"</span><span class="p">,</span>
    <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
    <span class="n">content</span><span class="o">=</span><span class="n">message</span>
<span class="p">)</span>

<span class="c1"># Process the response to get the final text
</span><span class="n">final_response</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">response</span><span class="p">.</span><span class="n">events</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="s">"content"</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="s">"agent"</span><span class="p">:</span>
        <span class="n">final_response</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">text</span>

<span class="c1"># Print the agent's response
</span><span class="k">print</span><span class="p">(</span><span class="s">"Session ID:"</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Agent Response:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">final_response</span><span class="p">)</span>

<span class="c1"># Print the session state for exploration
</span><span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Session State Exploration:"</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">session</span><span class="p">.</span><span class="n">state</span><span class="p">)</span>
</code></pre></div></div>

<p>Let’s break down what this script does:</p>

<ol>
  <li><strong>Set up the session service</strong>: We create an in-memory session service to manage our sessions</li>
  <li><strong>Define initial state</strong>: We set up a dictionary with user information</li>
  <li><strong>Create a session</strong>: We generate a unique ID and create a new session with our initial state</li>
  <li><strong>Create a runner</strong>: We connect our agent with the session service</li>
  <li><strong>Create a message</strong>: We format a user message to send to the agent</li>
  <li><strong>Run the agent</strong>: We execute the agent with our message in the context of our session</li>
  <li><strong>Process the response</strong>: We extract the final text from the event stream</li>
  <li><strong>Print results</strong>: We output the response and explore the session state</li>
</ol>

<h3 id="running-the-example">Running the Example</h3>

<p>Run the script with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>session_management
python basic_stateful_session.py
</code></pre></div></div>

<p>Example output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Session ID: 8a7b6c5d-4e3f-2d1c-0b9a-8a7b6c5d4e3f

Agent Response:
Brandon's favorite TV show is Game of Thrones. He's currently re-watching it as we speak.

Session State Exploration:
{'user_preferences': {'favorite_color': 'Blue',
                     'favorite_food': 'Pizza',
                     'favorite_movie': 'The Matrix',
                     'favorite_tv_show': 'Game of Thrones'},
 'username': 'Brandon'}
</code></pre></div></div>

<h2 id="understanding-the-agents-access-to-state">Understanding the Agent’s Access to State</h2>

<p>A key feature of ADK is that agents can access session state through template variables in their instructions. The syntax for accessing state is:</p>

<ul>
  <li>Simple key: <code class="language-plaintext highlighter-rouge">{key_name}</code></li>
  <li>Nested key: <code class="language-plaintext highlighter-rouge">{parent.child}</code></li>
  <li>Deep nesting: <code class="language-plaintext highlighter-rouge">{level1.level2.level3}</code></li>
</ul>

<p>When ADK initializes an agent for a response, it automatically replaces these templates with actual values from state.</p>

<h2 id="the-runner-lifecycle">The Runner Lifecycle</h2>

<p>To better understand how ADK works, let’s examine the lifecycle of a request through the runner:</p>

<ol>
  <li><strong>Request received</strong>: User sends a message</li>
  <li><strong>Session lookup</strong>: Runner finds the appropriate session</li>
  <li><strong>Agent selection</strong>: Runner determines which agent should handle the request</li>
  <li><strong>Context preparation</strong>: Runner combines session state with user message</li>
  <li><strong>Agent execution</strong>: Selected agent processes the request, possibly making tool calls</li>
  <li><strong>Session update</strong>: Runner updates the session with new events and state changes</li>
  <li><strong>Response returned</strong>: Final response is sent back to the user</li>
</ol>

<p>This process happens automatically with <code class="language-plaintext highlighter-rouge">runner.run()</code> or <code class="language-plaintext highlighter-rouge">runner.run_async()</code>.</p>

<h2 id="advanced-session-management-techniques">Advanced Session Management Techniques</h2>

<p>Now that we understand the basics, let’s explore some more advanced techniques.</p>

<h3 id="updating-state-dynamically">Updating State Dynamically</h3>

<p>You can update state during a conversation to store new information:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Update a top-level key
</span><span class="n">session</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="s">"username"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Alex"</span>

<span class="c1"># Update a nested key
</span><span class="n">session</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="s">"user_preferences"</span><span class="p">][</span><span class="s">"favorite_food"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Sushi"</span>

<span class="c1"># Add a new key
</span><span class="n">session</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="s">"last_interaction"</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">isoformat</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="managing-multiple-sessions">Managing Multiple Sessions</h3>

<p>In a real application, you’ll likely need to manage multiple sessions for different users:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get all sessions for a specific user
</span><span class="n">user_sessions</span> <span class="o">=</span> <span class="n">session_service</span><span class="p">.</span><span class="n">list_sessions</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="s">"MyApp"</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="s">"user123"</span><span class="p">)</span>

<span class="c1"># Check if the user has an existing session
</span><span class="k">if</span> <span class="n">user_sessions</span><span class="p">:</span>
    <span class="c1"># Use the most recent session
</span>    <span class="n">session_id</span> <span class="o">=</span> <span class="n">user_sessions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">id</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Create a new session
</span>    <span class="n">session_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">session_service</span><span class="p">.</span><span class="n">create_session</span><span class="p">(</span>
        <span class="n">app_name</span><span class="o">=</span><span class="s">"MyApp"</span><span class="p">,</span>
        <span class="n">user_id</span><span class="o">=</span><span class="s">"user123"</span><span class="p">,</span>
        <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
        <span class="n">state</span><span class="o">=</span><span class="n">initial_state</span>
    <span class="p">)</span>

<span class="c1"># Use the session
</span><span class="n">runner</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="s">"user123"</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="session-expiration-and-cleanup">Session Expiration and Cleanup</h3>

<p>For long-running applications, consider implementing session expiration:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">clean_old_sessions</span><span class="p">(</span><span class="n">session_service</span><span class="p">,</span> <span class="n">max_age_hours</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>
    <span class="s">"""Remove sessions older than the specified age."""</span>
    <span class="n">all_sessions</span> <span class="o">=</span> <span class="n">session_service</span><span class="p">.</span><span class="n">list_sessions</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="s">"MyApp"</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">all_sessions</span><span class="p">:</span>
        <span class="n">last_update</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">session</span><span class="p">.</span><span class="n">last_update_time</span><span class="p">)</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last_update</span>

        <span class="k">if</span> <span class="n">age</span><span class="p">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_age_hours</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">:</span>
            <span class="n">session_service</span><span class="p">.</span><span class="n">delete_session</span><span class="p">(</span>
                <span class="n">app_name</span><span class="o">=</span><span class="s">"MyApp"</span><span class="p">,</span>
                <span class="n">user_id</span><span class="o">=</span><span class="n">session</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">session_id</span><span class="o">=</span><span class="n">session</span><span class="p">.</span><span class="nb">id</span>
            <span class="p">)</span>
</code></pre></div></div>

<h2 id="building-an-interactive-chat-loop">Building an Interactive Chat Loop</h2>

<p>Let’s create a more realistic example with an interactive chat loop:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">google.adk.orchestration</span> <span class="kn">import</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="nn">google.adk.orchestration.session</span> <span class="kn">import</span> <span class="n">InMemorySessionService</span>
<span class="kn">from</span> <span class="nn">google.generativeai.types</span> <span class="kn">import</span> <span class="n">content_types</span>
<span class="kn">from</span> <span class="nn">google.generativeai.types.content_types</span> <span class="kn">import</span> <span class="n">Part</span>

<span class="c1"># Import the agent
</span><span class="kn">from</span> <span class="nn">qa_agent.agent</span> <span class="kn">import</span> <span class="n">qa_agent</span>

<span class="c1"># Load environment variables
</span><span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># Setup session service
</span><span class="n">session_service</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>

<span class="c1"># Define initial state
</span><span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"username"</span><span class="p">:</span> <span class="s">"User"</span><span class="p">,</span>
    <span class="s">"chat_history"</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s">"user_preferences"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"favorite_color"</span><span class="p">:</span> <span class="s">"Unknown"</span><span class="p">,</span>
        <span class="s">"favorite_food"</span><span class="p">:</span> <span class="s">"Unknown"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s">"first_interaction"</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">isoformat</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1"># Create or retrieve session
</span><span class="k">def</span> <span class="nf">get_or_create_session</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="n">session_service</span><span class="p">.</span><span class="n">list_sessions</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">app_name</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sessions</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sessions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">session_service</span><span class="p">.</span><span class="n">create_session</span><span class="p">(</span>
            <span class="n">app_name</span><span class="o">=</span><span class="n">app_name</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="n">initial_state</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">session_id</span>

<span class="c1"># Process agent response
</span><span class="k">def</span> <span class="nf">process_agent_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="n">final_text</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">response</span><span class="p">.</span><span class="n">events</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="s">"content"</span> <span class="ow">and</span> <span class="n">event</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">role</span> <span class="o">==</span> <span class="s">"agent"</span><span class="p">:</span>
            <span class="n">final_text</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">text</span>
    <span class="k">return</span> <span class="n">final_text</span>

<span class="c1"># Update preferences in state
</span><span class="k">def</span> <span class="nf">update_preferences</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">session</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="s">"user_preferences"</span><span class="p">]:</span>
        <span class="n">session</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="s">"user_preferences"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="c1"># Main chat loop
</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">app_name</span> <span class="o">=</span> <span class="s">"PreferenceChat"</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="s">"interactive_user"</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="n">get_or_create_session</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>

    <span class="c1"># Create runner
</span>    <span class="n">runner</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
        <span class="n">root_agent</span><span class="o">=</span><span class="n">qa_agent</span><span class="p">,</span>
        <span class="n">session_service</span><span class="o">=</span><span class="n">session_service</span>
    <span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"Welcome to PreferenceChat! Type 'exit' to quit."</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"You can set preferences with: 'set preference [key] [value]'"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Example: set preference favorite_color blue</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">user_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"You: "</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">user_input</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">"exit"</span><span class="p">,</span> <span class="s">"quit"</span><span class="p">]:</span>
            <span class="k">break</span>

        <span class="c1"># Check for preference setting command
</span>        <span class="k">if</span> <span class="n">user_input</span><span class="p">.</span><span class="n">lower</span><span class="p">().</span><span class="n">startswith</span><span class="p">(</span><span class="s">"set preference "</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">" "</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">parts</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">session_service</span><span class="p">.</span><span class="n">get_session</span><span class="p">(</span>
                    <span class="n">app_name</span><span class="o">=</span><span class="n">app_name</span><span class="p">,</span>
                    <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                    <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">update_preferences</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Agent: I've updated your </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s">."</span><span class="p">)</span>
                    <span class="k">continue</span>

        <span class="c1"># Create message and run agent
</span>        <span class="n">message</span> <span class="o">=</span> <span class="n">content_types</span><span class="p">.</span><span class="n">Content</span><span class="p">(</span>
            <span class="n">role</span><span class="o">=</span><span class="s">"user"</span><span class="p">,</span>
            <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">Part</span><span class="p">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">user_input</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">runner</span><span class="p">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">message</span>
        <span class="p">)</span>

        <span class="n">agent_response</span> <span class="o">=</span> <span class="n">process_agent_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Agent: </span><span class="si">{</span><span class="n">agent_response</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

        <span class="c1"># Update chat history in state
</span>        <span class="n">session</span> <span class="o">=</span> <span class="n">session_service</span><span class="p">.</span><span class="n">get_session</span><span class="p">(</span>
            <span class="n">app_name</span><span class="o">=</span><span class="n">app_name</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
            <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span>
        <span class="p">)</span>

        <span class="c1"># Add to chat history
</span>        <span class="n">session</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="s">"chat_history"</span><span class="p">].</span><span class="n">append</span><span class="p">({</span>
            <span class="s">"timestamp"</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s">"user"</span><span class="p">:</span> <span class="n">user_input</span><span class="p">,</span>
            <span class="s">"agent"</span><span class="p">:</span> <span class="n">agent_response</span>
        <span class="p">})</span>

        <span class="c1"># Also update last interaction time
</span>        <span class="n">session</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="s">"last_interaction"</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">isoformat</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>This script demonstrates:</p>
<ul>
  <li>Creating or retrieving sessions</li>
  <li>Interactive chat with the agent</li>
  <li>Updating preferences with special commands</li>
  <li>Maintaining a chat history in state</li>
  <li>Tracking interaction timestamps</li>
</ul>

<h2 id="understanding-state-access-in-tool-context">Understanding State Access in Tool Context</h2>

<p>When using tools with agents, you can access and modify state within tool functions using the <code class="language-plaintext highlighter-rouge">tool_context</code> parameter:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">add_to_favorites</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="s">"""
    Adds an item to the user's favorites in the specified category.

    Args:
        item: The item to add as a favorite
        category: The category for this favorite (e.g., 'movie', 'food')
        tool_context: Provided by ADK, contains session information

    Returns:
        A dictionary with the result of the operation
    """</span>
    <span class="c1"># Access state from tool_context
</span>    <span class="n">state</span> <span class="o">=</span> <span class="n">tool_context</span><span class="p">.</span><span class="n">state</span>

    <span class="c1"># Make sure favorites exist in state
</span>    <span class="k">if</span> <span class="s">"favorites"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s">"favorites"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Add or update the favorite
</span>    <span class="n">state</span><span class="p">[</span><span class="s">"favorites"</span><span class="p">][</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s">"action"</span><span class="p">:</span> <span class="s">"add_favorite"</span><span class="p">,</span>
        <span class="s">"category"</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
        <span class="s">"item"</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span>
        <span class="s">"result"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"Added </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s"> as favorite </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s">"</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>We’ll explore this more in our callbacks tutorial.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Session and state management are foundational concepts in ADK that enable agents to maintain context across interactions. By understanding these components, you can build more sophisticated agent applications that remember information, track user preferences, and provide consistent experiences.</p>

<p>In this tutorial, we’ve covered:</p>
<ul>
  <li>The core components of ADK’s memory management</li>
  <li>Creating and managing in-memory sessions</li>
  <li>Setting and accessing state</li>
  <li>The runner lifecycle</li>
  <li>Advanced session management techniques</li>
  <li>Building interactive chat applications</li>
</ul>

<p>In the next part of our series, we’ll explore how to persist sessions to a database, allowing your agents to maintain context even after your application restarts.</p>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="https://cloud.google.com/vertex-ai/docs/generative-ai/agents/agent-development-kit/sessions">ADK Session Management Documentation</a></li>
  <li><a href="https://cloud.google.com/vertex-ai/docs/generative-ai/agents/agent-development-kit/state">ADK State Documentation</a></li>
  <li><a href="https://cloud.google.com/vertex-ai/docs/generative-ai/agents/agent-development-kit/runner">ADK Runner Documentation</a></li>
</ul>

<div class="mermaid" data-original-code="graph TD
    A[User Request] --&gt; B{Session Exists?}
    B --&gt;|No| C[Create New Session]
    B --&gt;|Yes| D[Load Existing Session]
    C --&gt; E[Initialize State]
    D --&gt; F[Access Current State]
    E --&gt; G[Runner]
    F --&gt; G
    G --&gt; H[Agent]
    H --&gt; I[Process Request]
    I --&gt; J[Update State]
    J --&gt; K[Return Response]
    K --&gt; L[Save Session]
" data-processed="true"><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="-8 -8 355.9583740234375 1031.0104370117188" style="max-width: 355.9583740234375px;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-1749092338868"><style>#mermaid-1749092338868{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}#mermaid-1749092338868 .error-icon{fill:#a44141;}#mermaid-1749092338868 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-1749092338868 .edge-thickness-normal{stroke-width:2px;}#mermaid-1749092338868 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1749092338868 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1749092338868 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1749092338868 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1749092338868 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-1749092338868 .marker.cross{stroke:lightgrey;}#mermaid-1749092338868 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-1749092338868 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-1749092338868 .cluster-label text{fill:#F9FFFE;}#mermaid-1749092338868 .cluster-label span,#mermaid-1749092338868 p{color:#F9FFFE;}#mermaid-1749092338868 .label text,#mermaid-1749092338868 span,#mermaid-1749092338868 p{fill:#ccc;color:#ccc;}#mermaid-1749092338868 .node rect,#mermaid-1749092338868 .node circle,#mermaid-1749092338868 .node ellipse,#mermaid-1749092338868 .node polygon,#mermaid-1749092338868 .node path{fill:#1f2020;stroke:#81B1DB;stroke-width:1px;}#mermaid-1749092338868 .flowchart-label text{text-anchor:middle;}#mermaid-1749092338868 .node .label{text-align:center;}#mermaid-1749092338868 .node.clickable{cursor:pointer;}#mermaid-1749092338868 .arrowheadPath{fill:lightgrey;}#mermaid-1749092338868 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-1749092338868 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-1749092338868 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-1749092338868 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-1749092338868 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-1749092338868 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-1749092338868 .cluster text{fill:#F9FFFE;}#mermaid-1749092338868 .cluster span,#mermaid-1749092338868 p{color:#F9FFFE;}#mermaid-1749092338868 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-1749092338868 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-1749092338868 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="6" viewBox="0 0 10 10" class="marker flowchart" id="mermaid-1749092338868_flowchart-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart" id="mermaid-1749092338868_flowchart-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart" id="mermaid-1749092338868_flowchart-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart" id="mermaid-1749092338868_flowchart-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart" id="mermaid-1749092338868_flowchart-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart" id="mermaid-1749092338868_flowchart-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid-1749092338868_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-A LE-B" id="L-A-B-0" d="M167.568,43L167.568,47.167C167.568,51.333,167.568,59.667,167.634,67.2C167.7,74.734,167.832,81.467,167.898,84.834L167.964,88.201"></path><path marker-end="url(#mermaid-1749092338868_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-B LE-C" id="L-B-C-0" d="M133.494,208.936L122.924,221.115C112.355,233.294,91.217,257.652,80.647,275.448C70.078,293.244,70.078,304.477,70.078,310.094L70.078,315.71"></path><path marker-end="url(#mermaid-1749092338868_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-B LE-D" id="L-B-D-0" d="M202.642,208.936L213.044,221.115C223.447,233.294,244.252,257.652,254.655,275.448C265.057,293.244,265.057,304.477,265.057,310.094L265.057,315.71"></path><path marker-end="url(#mermaid-1749092338868_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-C LE-E" id="L-C-E-0" d="M70.078,364.01L70.078,368.177C70.078,372.344,70.078,380.677,70.078,388.127C70.078,395.577,70.078,402.144,70.078,405.427L70.078,408.71"></path><path marker-end="url(#mermaid-1749092338868_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-D LE-F" id="L-D-F-0" d="M265.057,364.01L265.057,368.177C265.057,372.344,265.057,380.677,265.057,388.127C265.057,395.577,265.057,402.144,265.057,405.427L265.057,408.71"></path><path marker-end="url(#mermaid-1749092338868_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-E LE-G" id="L-E-G-0" d="M70.078,457.01L70.078,461.177C70.078,465.344,70.078,473.677,80.551,482.839C91.023,492.001,111.969,501.991,122.442,506.986L132.914,511.982"></path><path marker-end="url(#mermaid-1749092338868_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-F LE-G" id="L-F-G-0" d="M265.057,457.01L265.057,461.177C265.057,465.344,265.057,473.677,254.585,482.839C244.112,492.001,223.167,501.991,212.694,506.986L202.221,511.982"></path><path marker-end="url(#mermaid-1749092338868_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-G LE-H" id="L-G-H-0" d="M167.568,550.01L167.568,554.177C167.568,558.344,167.568,566.677,167.568,574.127C167.568,581.577,167.568,588.144,167.568,591.427L167.568,594.71"></path><path marker-end="url(#mermaid-1749092338868_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-H LE-I" id="L-H-I-0" d="M167.568,643.01L167.568,647.177C167.568,651.344,167.568,659.677,167.568,667.127C167.568,674.577,167.568,681.144,167.568,684.427L167.568,687.71"></path><path marker-end="url(#mermaid-1749092338868_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-I LE-J" id="L-I-J-0" d="M167.568,736.01L167.568,740.177C167.568,744.344,167.568,752.677,167.568,760.127C167.568,767.577,167.568,774.144,167.568,777.427L167.568,780.71"></path><path marker-end="url(#mermaid-1749092338868_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-J LE-K" id="L-J-K-0" d="M167.568,829.01L167.568,833.177C167.568,837.344,167.568,845.677,167.568,853.127C167.568,860.577,167.568,867.144,167.568,870.427L167.568,873.71"></path><path marker-end="url(#mermaid-1749092338868_flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-K LE-L" id="L-K-L-0" d="M167.568,922.01L167.568,926.177C167.568,930.344,167.568,938.677,167.568,946.127C167.568,953.577,167.568,960.144,167.568,963.427L167.568,966.71"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g transform="translate(70.078125, 282.0104217529297)" class="edgeLabel"><g transform="translate(-8.385416984558105, -14)" class="label"><foreignobject height="28" width="16.77083396911621"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">No</span></div></foreignobject></g></g><g transform="translate(265.0572967529297, 282.0104217529297)" class="edgeLabel"><g transform="translate(-10.151041984558105, -14)" class="label"><foreignobject height="28" width="20.30208396911621"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel">Yes</span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignobject></g></g></g><g class="nodes"><g transform="translate(167.56771087646484, 21.5)" data-id="A" data-node="true" id="flowchart-A-24" class="node default default flowchart-label"><rect height="43" width="98.48958587646484" y="-21.5" x="-49.24479293823242" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-41.74479293823242, -14)" style="" class="label"><rect></rect><foreignobject height="28" width="83.48958587646484"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">User Request</span></div></foreignobject></g></g><g transform="translate(167.56771087646484, 168.00521087646484)" data-id="B" data-node="true" id="flowchart-B-25" class="node default default flowchart-label"><polygon style="" transform="translate(-75.00521087646484,75.00521087646484)" class="label-container" points="75.00521087646484,0 150.0104217529297,-75.00521087646484 75.00521087646484,-150.0104217529297 0,-75.00521087646484"></polygon><g transform="translate(-46.005210876464844, -14)" style="" class="label"><rect></rect><foreignobject height="28" width="92.01042175292969"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Session Exists?</span></div></foreignobject></g></g><g transform="translate(70.078125, 342.5104217529297)" data-id="C" data-node="true" id="flowchart-C-27" class="node default default flowchart-label"><rect height="43" width="140.15625" y="-21.5" x="-70.078125" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-62.578125, -14)" style="" class="label"><rect></rect><foreignobject height="28" width="125.15625"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Create New Session</span></div></foreignobject></g></g><g transform="translate(265.0572967529297, 342.5104217529297)" data-id="D" data-node="true" id="flowchart-D-29" class="node default default flowchart-label"><rect height="43" width="149.80209350585938" y="-21.5" x="-74.90104675292969" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-67.40104675292969, -14)" style="" class="label"><rect></rect><foreignobject height="28" width="134.80209350585938"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Load Existing Session</span></div></foreignobject></g></g><g transform="translate(70.078125, 435.5104217529297)" data-id="E" data-node="true" id="flowchart-E-31" class="node default default flowchart-label"><rect height="43" width="109.44792175292969" y="-21.5" x="-54.723960876464844" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-47.223960876464844, -14)" style="" class="label"><rect></rect><foreignobject height="28" width="94.44792175292969"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Initialize State</span></div></foreignobject></g></g><g transform="translate(265.0572967529297, 435.5104217529297)" data-id="F" data-node="true" id="flowchart-F-33" class="node default default flowchart-label"><rect height="43" width="148.30209350585938" y="-21.5" x="-74.15104675292969" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-66.65104675292969, -14)" style="" class="label"><rect></rect><foreignobject height="28" width="133.30209350585938"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Access Current State</span></div></foreignobject></g></g><g transform="translate(167.56771087646484, 528.5104217529297)" data-id="G" data-node="true" id="flowchart-G-35" class="node default default flowchart-label"><rect height="43" width="59.739585876464844" y="-21.5" x="-29.869792938232422" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-22.369792938232422, -14)" style="" class="label"><rect></rect><foreignobject height="28" width="44.739585876464844"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Runner</span></div></foreignobject></g></g><g transform="translate(167.56771087646484, 621.5104217529297)" data-id="H" data-node="true" id="flowchart-H-39" class="node default default flowchart-label"><rect height="43" width="51.927085876464844" y="-21.5" x="-25.963542938232422" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-18.463542938232422, -14)" style="" class="label"><rect></rect><foreignobject height="28" width="36.927085876464844"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Agent</span></div></foreignobject></g></g><g transform="translate(167.56771087646484, 714.5104217529297)" data-id="I" data-node="true" id="flowchart-I-41" class="node default default flowchart-label"><rect height="43" width="117.14583587646484" y="-21.5" x="-58.57291793823242" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-51.07291793823242, -14)" style="" class="label"><rect></rect><foreignobject height="28" width="102.14583587646484"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Process Request</span></div></foreignobject></g></g><g transform="translate(167.56771087646484, 807.5104217529297)" data-id="J" data-node="true" id="flowchart-J-43" class="node default default flowchart-label"><rect height="43" width="99.1875" y="-21.5" x="-49.59375" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-42.09375, -14)" style="" class="label"><rect></rect><foreignobject height="28" width="84.1875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Update State</span></div></foreignobject></g></g><g transform="translate(167.56771087646484, 900.5104217529297)" data-id="K" data-node="true" id="flowchart-K-45" class="node default default flowchart-label"><rect height="43" width="120.28125" y="-21.5" x="-60.140625" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-52.640625, -14)" style="" class="label"><rect></rect><foreignobject height="28" width="105.28125"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Return Response</span></div></foreignobject></g></g><g transform="translate(167.56771087646484, 993.5104217529297)" data-id="L" data-node="true" id="flowchart-L-47" class="node default default flowchart-label"><rect height="43" width="94.58333587646484" y="-21.5" x="-47.29166793823242" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-39.79166793823242, -14)" style="" class="label"><rect></rect><foreignobject height="28" width="79.58333587646484"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Save Session</span></div></foreignobject></g></g></g></g></g></svg></div>
<p><a href="https://saptak.in/writing/2025/05/10/google-adk-masterclass-part6">Next…</a></p>

  </div>
  
  
  <div class="image-credit-footer">
    <p><em>Header image: Photo by ThisisEngineering on Unsplash</em></p>
  </div>
  
  
  <div class="mt4 mb4"><div class="clearfix mxn1">
  <div class="md-col md-col-6 px1">
    
      <a href="https://saptak.in/writing/2025/05/10/google-adk-masterclass-part4">
        <div class="h6 caps gray">Previous</div>
        <h4 class="mt0">Google ADK Masterclass Part 4: Structured Outputs with ADK</h4>
      </a>
    
  </div>
  <div class="md-col md-col-6 px1 right-align">
    
      <a href="https://saptak.in/writing/2025/05/10/google-adk-masterclass-part6">
        <div class="h6 caps gray">Next</div>
        <h4 class="mt0">Google ADK Masterclass Part 6: Persisting Sessions to a Database</h4>
      </a>    
    
  </div>
</div></div>
  <div class="mt4"><div class="circle-line-image center mt1">
  <a href="https://saptak.in/writing/2025/05/10/google-adk-masterclass-part5">
    <img data-src="/assets/img/saptak_profile_med.jpg" alt="Saptak Sen" class=" border bg-white border-light-gray circle square-100 lazyloaded" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/saptak_profile_med.jpg">

  </a>
</div>
<div class="clearfix">
  <div class="sm-col sm-col-7">
    <a href="https://saptak.in/writing/2025/05/10/google-adk-masterclass-part5"><h3>Saptak Sen</h3></a>
    <p class="h5">
      If you enjoyed this post, you should check out my book:
      <a href="https://saptak.in/writing/2025/05/10/google-adk-masterclass-part5?ref=saptak-post-bottom" target="_blank">Starting with Spark</a>.
    </p>
  </div>
  <div class="sm-col-right">
    <h3>Share this post</h3>
    




<a href="https://twitter.com/share?url=https://saptak.in/writing/2025/05/10/google-adk-masterclass-part5&amp;text=Google%20ADK%20Masterclass%20Part%205:%20Session%20and%20Memory%20Management" target="_blank" class="fa fa-fw fa-lg fa-twitter-square gray"></a>
<a href="https://www.linkedin.com/shareArticle?url=https://saptak.in/writing/2025/05/10/google-adk-masterclass-part5&amp;title=Google%20ADK%20Masterclass%20Part%205:%20Session%20and%20Memory%20Management" target="_blank" class="fa fa-fw fa-lg fa-linkedin-square gray"></a>
<a href="https://www.facebook.com/sharer.php?u=https://saptak.in/writing/2025/05/10/google-adk-masterclass-part5" target="_blank" class="fa fa-fw fa-lg fa-facebook-square gray"></a>
<a href="https://plus.google.com/share?url=https://saptak.in/writing/2025/05/10/google-adk-masterclass-part5" target="_blank" class="fa fa-fw fa-lg fa-google-plus-square gray"></a>
<a href="http://reddit.com/submit?url=https://saptak.in/writing/2025/05/10/google-adk-masterclass-part5&amp;title=Google%20ADK%20Masterclass%20Part%205:%20Session%20and%20Memory%20Management" target="_blank" class="fa fa-fw fa-lg fa-reddit-square gray"></a>
<a href="http://news.ycombinator.com/submitlink?u=https://saptak.in/writing/2025/05/10/google-adk-masterclass-part5&amp;t=Google%20ADK%20Masterclass%20Part%205:%20Session%20and%20Memory%20Management" target="_blank" class="fa fa-fw fa-lg fa-hacker-news gray"></a>
  </div>
</div>
</div>
</article>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const ttsButton = document.getElementById('tts-button');
    const postContent = document.getElementById('post-content-for-tts');
    let isSpeaking = false;
    let utterance = null;

    // Check if SpeechSynthesis is supported
    if (!('speechSynthesis' in window)) {
      console.warn('Speech Synthesis not supported in this browser.');
      if (ttsButton) {
        ttsButton.style.display = 'none'; // Hide button if not supported
      }
      return; 
    }
    
    // Ensure button and content exist
    if (!ttsButton || !postContent) {
        console.error('TTS button or content element not found.');
        if (ttsButton) ttsButton.style.display = 'none'; // Hide button if elements missing
        return;
    }

    ttsButton.addEventListener('click', () => {
      if (isSpeaking) {
        speechSynthesis.cancel(); // Stop speaking
        // Note: onend event will handle resetting the button state
      } else {
        const textToSpeak = postContent.textContent || postContent.innerText || '';
        if (textToSpeak.trim().length === 0) {
            console.warn('No text content found to speak.');
            return;
        }
        
        utterance = new SpeechSynthesisUtterance(textToSpeak);
        // SVG Icons
        const playIconSVG = `
          <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>`;
        const stopIconSVG = `
          <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
            <path d="M6 6h12v12H6z"/>
          </svg>`;

        utterance.onstart = () => {
            isSpeaking = true;
            ttsButton.innerHTML = stopIconSVG; // Stop icon SVG
            ttsButton.setAttribute('aria-label', 'Stop listening');
            ttsButton.setAttribute('title', 'Stop listening');
            console.log('Speech synthesis started.');
        };

        const resetButtonToPlay = () => {
          isSpeaking = false;
          ttsButton.innerHTML = playIconSVG; // Play icon SVG
          ttsButton.setAttribute('aria-label', 'Listen to this post');
          ttsButton.setAttribute('title', 'Listen to this post');
        }

        utterance.onend = () => {
          resetButtonToPlay();
          console.log('Speech synthesis finished.');
        };

        // Ensure button resets on error
        utterance.onerror = (event) => {
          console.error('Speech synthesis error:', event);
          resetButtonToPlay();
        };
        // Clear queue and speak
        speechSynthesis.cancel(); // Ensure nothing else is queued or speaking
        speechSynthesis.speak(utterance);
      }
    });

    // Optional: Stop speech synthesis when navigating away
    window.addEventListener('beforeunload', () => {
        if (isSpeaking) {
            speechSynthesis.cancel();
        }
    });
  });
</script>

  </main>
  
  <footer class="sticky-footer border-top border-light-gray gray h6">

  <div class="sm-col px2">
    © 2025 Saptak Sen.
  </div>
  <div class="sm-col-right px2">
    
      
      <a href="https://twitter.com/saptak" target="_blank" class="gray hint--top" data-hint="Twitter">
        <i class="fa fa-fw fa-lg fa-twitter-square"></i>
      </a>
    
      
      <a href="https://www.linkedin.com/in/saptak" target="_blank" class="gray hint--top" data-hint="LinkedIn">
        <i class="fa fa-fw fa-lg fa-linkedin-square"></i>
      </a>
    
      
      <a href="https://www.facebook.com/saptak" target="_blank" class="gray hint--top" data-hint="Facebook">
        <i class="fa fa-fw fa-lg fa-facebook-square"></i>
      </a>
    
      
      <a href="https://plus.google.com/+SaptakSen" target="_blank" class="gray hint--top" data-hint="Google+">
        <i class="fa fa-fw fa-lg fa-google-plus-square"></i>
      </a>
    
      
      <a href="https://www.slideshare.net/saptak" target="_blank" class="gray hint--top" data-hint="SlideShare">
        <i class="fa fa-fw fa-lg fa-slideshare"></i>
      </a>
    
      
      <a href="https://github.com/saptak" target="_blank" class="gray hint--top" data-hint="GitHub">
        <i class="fa fa-fw fa-lg fa-github-square"></i>
      </a>
    
      
      <a href="mailto:sen@saptak.in" target="_blank" class="gray hint--top" data-hint="Email">
        <i class="fa fa-fw fa-lg fa-envelope-square"></i>
      </a>
    
    <script>
    (function() {
      var cx = '007069857876288036852:0b2gkhh00ey';
      var gcse = document.createElement('script');
      gcse.type = 'text/javascript';
      gcse.async = true;
      gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(gcse, s);
    })();
  </script>
  <div id="___gcse_0"><div class="gsc-control-cse gsc-control-cse-en"><div class="gsc-control-wrapper-cse" dir="ltr"><form class="gsc-search-box gsc-search-box-tools" accept-charset="utf-8"><table cellspacing="0" cellpadding="0" role="presentation" class="gsc-search-box"><tbody><tr><td class="gsc-input"><div class="gsc-input-box" id="gsc-iw-id1"><table cellspacing="0" cellpadding="0" role="presentation" id="gs_id50" class="gstl_50 gsc-input" style="width: 100%; padding: 0px;"><tbody><tr><td id="gs_tti50" class="gsib_a"><input autocomplete="off" type="text" size="10" class="gsc-input" name="search" title="search" aria-label="search" id="gsc-i-id1" dir="ltr" spellcheck="false" style="width: 100%; padding: 0px; border: none; margin: 0px; height: auto; background: url(&quot;https://www.google.com/cse/static/images/1x/en/branding.png&quot;) left center no-repeat rgb(255, 255, 255); outline: none;"></td><td class="gsib_b"><div class="gsst_b" id="gs_st50" dir="ltr"><a class="gsst_a" href="javascript:void(0)" title="Clear search box" role="button" style="display: none;"><span class="gscb_a" id="gs_cb50" aria-hidden="true">×</span></a></div></td></tr></tbody></table></div></td><td class="gsc-search-button"><button class="gsc-search-button gsc-search-button-v2"><svg width="13" height="13" viewBox="0 0 13 13"><title>search</title><path d="m4.8495 7.8226c0.82666 0 1.5262-0.29146 2.0985-0.87438 0.57232-0.58292 0.86378-1.2877 0.87438-2.1144 0.010599-0.82666-0.28086-1.5262-0.87438-2.0985-0.59352-0.57232-1.293-0.86378-2.0985-0.87438-0.8055-0.010599-1.5103 0.28086-2.1144 0.87438-0.60414 0.59352-0.8956 1.293-0.87438 2.0985 0.021197 0.8055 0.31266 1.5103 0.87438 2.1144 0.56172 0.60414 1.2665 0.8956 2.1144 0.87438zm4.4695 0.2115 3.681 3.6819-1.259 1.284-3.6817-3.7 0.0019784-0.69479-0.090043-0.098846c-0.87973 0.76087-1.92 1.1413-3.1207 1.1413-1.3553 0-2.5025-0.46363-3.4417-1.3909s-1.4088-2.0686-1.4088-3.4239c0-1.3553 0.4696-2.4966 1.4088-3.4239 0.9392-0.92727 2.0864-1.3969 3.4417-1.4088 1.3553-0.011889 2.4906 0.45771 3.406 1.4088 0.9154 0.95107 1.379 2.0924 1.3909 3.4239 0 1.2126-0.38043 2.2588-1.1413 3.1385l0.098834 0.090049z"></path></svg></button></td><td class="gsc-clear-button"><div class="gsc-clear-button" title="clear results">&nbsp;</div></td></tr></tbody></table></form><div class="gsc-results-wrapper-overlay"><div class="gsc-results-close-btn" tabindex="0"></div><div class="gsc-positioningWrapper"><div class="gsc-tabsAreaInvisible"><div aria-label="refinement" role="tab" class="gsc-tabHeader gsc-inline-block gsc-tabhActive">Custom Search</div><span class="gs-spacer"> </span></div></div><div class="gsc-positioningWrapper"><div class="gsc-refinementsAreaInvisible"></div></div><div class="gsc-above-wrapper-area-invisible"><div class="gsc-above-wrapper-area-backfill-container"></div><table cellspacing="0" cellpadding="0" role="presentation" class="gsc-above-wrapper-area-container"><tbody><tr><td class="gsc-result-info-container"><div class="gsc-result-info-invisible"></div></td><td class="gsc-orderby-container"><div class="gsc-orderby-invisible"><div class="gsc-orderby-label gsc-inline-block">Sort by:</div><div class="gsc-option-menu-container gsc-inline-block"><div class="gsc-selected-option-container gsc-inline-block"><div class="gsc-selected-option">Relevance</div><div class="gsc-option-selector"></div></div><div class="gsc-option-menu-invisible"><div class="gsc-option-menu-item gsc-option-menu-item-highlighted"><div class="gsc-option">Relevance</div></div><div class="gsc-option-menu-item"><div class="gsc-option">Date</div></div></div></div></div></td></tr></tbody></table></div><div class="gsc-adBlockInvisible"></div><div class="gsc-wrapper"><div class="gsc-adBlockInvisible"></div><div class="gsc-resultsbox-invisible"><div class="gsc-resultsRoot gsc-tabData gsc-tabdActive"><div><div class="gsc-expansionArea"></div></div></div></div></div></div><div class="gsc-modal-background-image" tabindex="0"></div></div></div></div>
  </div>

</footer>

  <script type="text/javascript" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/main.js.download"></script>
<script type="text/javascript" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/dark-mode.js.download"></script>
<script type="text/javascript" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/nav-override.js.download"></script>
<script type="text/javascript" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/mobile-responsive-new.js.download"></script>
<script type="text/javascript" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/title-fix.js.download"></script>
<script type="text/javascript" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/tag-fix.js.download"></script>
<script type="text/javascript" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/inline-tags-fix.js.download"></script>
<script type="text/javascript" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/mobile-tag-fix.js.download"></script>
<script type="text/javascript" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/no-hamburger.js.download"></script>
<script type="text/javascript" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/direct-tag-fix.js.download"></script>
<script type="text/javascript" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/force-inline-tags.js.download"></script>
<script type="text/javascript" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/mermaid.min.js.download"></script>
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Mermaid
    mermaid.initialize({
      startOnLoad: false, // We'll manually render diagrams
      theme: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'
    });

    // Find all code blocks with language-mermaid class and convert them
    document.querySelectorAll('pre code.language-mermaid').forEach(function(codeBlock) {
      // Save the original code
      var originalCode = codeBlock.textContent;

      // Create a div to replace the code block
      var div = document.createElement('div');
      div.className = 'mermaid';
      div.innerHTML = originalCode;
      div.style.backgroundColor = 'transparent';

      // Store the original code for potential re-renders
      div.setAttribute('data-original-code', originalCode);

      // Replace the <pre><code> with the mermaid div
      var pre = codeBlock.parentNode;
      pre.parentNode.replaceChild(div, pre);
    });

    // Run the renderer
    try {
      mermaid.run();
    } catch (e) {
      console.error('Error initializing Mermaid diagrams:', e);
    }
  });
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="./Google ADK Masterclass Part 5_ Session and Memory Management_files/js(1)"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  // Universal Analytics configuration
  gtag('config', 'UA-59342910-1', {
    'anonymize_ip': true,
    'cookie_flags': 'SameSite=None;Secure'
  });
</script>


  <!-- Immediate inline script to fix tags -->
<script>
  (function() {
    // Execute immediately
    function fixTags() {
      // Select all tags
      var tagLinks = document.querySelectorAll('a[href*="#"]');
      for (var i = 0; i < tagLinks.length; i++) {
        var link = tagLinks[i];
        if (link.getAttribute('href').includes('/tags/') || 
            link.getAttribute('href').startsWith('#')) {
          link.style.cssText = 'display: inline !important; float: none !important;';
          
          // Fix parents
          if (link.parentNode) {
            link.parentNode.style.cssText = 'display: inline !important; white-space: normal !important;';
            
            if (link.parentNode.parentNode) {
              link.parentNode.parentNode.style.cssText = 'display: block !important; white-space: normal !important;';
            }
          }
        }
      }
    }
    
    // Run immediately 
    fixTags();
    
    // And also run after the page is fully loaded
    document.addEventListener('DOMContentLoaded', fixTags);
    
    // And also run after a short delay to catch any late changes
    setTimeout(fixTags, 500);
  })();
</script>



<div class="mermaidTooltip" style="opacity: 0;"></div><table cellspacing="0" cellpadding="0" role="presentation" class="gstl_50 gssb_c" style="width: 115px; display: none; top: 16360px; left: 1344px; position: absolute;"><tbody><tr><td class="gssb_f"></td><td class="gssb_e" style="width: 100%;"></td></tr></tbody></table></body></html>